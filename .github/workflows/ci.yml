name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Quality Checks (Lint, Type Check, Tests)
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Check environment variables
        run: |
          chmod +x scripts/utils/check-env.sh
          ./scripts/utils/check-env.sh development
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://dummy:dummy@localhost:5432/dummy' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'dummy-secret-for-ci-only-minimum-32-chars' }}
          NEXTAUTH_URL: 'http://localhost:3000'

      - name: Run all quality checks
        run: |
          chmod +x scripts/quality/run-all-checks.sh
          ./scripts/quality/run-all-checks.sh --fast
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://dummy:dummy@localhost:5432/dummy' }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'dummy-secret-for-ci-only-minimum-32-chars' }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            coverage/
            test-results/
          retention-days: 30

  # Job 2: Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Run npm audit
        run: |
          echo "=== Running npm audit ==="
          npm audit --audit-level=moderate || true

          echo ""
          echo "=== Generating detailed audit report ==="
          npm audit --json > audit-report.json || true

      - name: Check for high/critical vulnerabilities
        run: |
          HIGH_VULNS=$(npm audit --json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(npm audit --json | jq '.metadata.vulnerabilities.critical // 0')

          echo "High vulnerabilities: $HIGH_VULNS"
          echo "Critical vulnerabilities: $CRITICAL_VULNS"

          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found!"
            exit 1
          fi

          if [ "$HIGH_VULNS" -gt 5 ]; then
            echo "âš ï¸  Warning: More than 5 high vulnerabilities found"
            exit 1
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit-report.json
          retention-days: 30

  # Job 3: Code Coverage
  coverage:
    name: Code Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run tests with coverage
        run: npm run test:coverage
        env:
          DATABASE_URL: 'postgresql://dummy:dummy@localhost:5432/dummy'
          NEXTAUTH_SECRET: 'dummy-secret-for-ci-only-minimum-32-chars'

      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Coverage: $COVERAGE%"
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: Upload coverage to Codecov
        if: github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const { lines, statements, functions, branches } = coverage.total;

            const comment = `## ðŸ“Š Code Coverage Report

            | Metric | Coverage |
            |--------|----------|
            | Lines | ${lines.pct}% |
            | Statements | ${statements.pct}% |
            | Functions | ${functions.pct}% |
            | Branches | ${branches.pct}% |

            ${lines.pct >= 95 ? 'âœ…' : 'âš ï¸'} Coverage threshold: 95%
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 4: Build Documentation
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate API documentation
        run: |
          echo "=== Generating API Documentation ==="
          mkdir -p docs/api

          # Generate TypeScript documentation using TypeDoc (if configured)
          if [ -f "typedoc.json" ]; then
            npx typedoc
          else
            echo "TypeDoc not configured, skipping..."
          fi

      - name: Generate Prisma schema documentation
        run: |
          echo "=== Documenting Database Schema ==="
          npx prisma validate

          # Export schema to readable format
          cat prisma/schema.prisma > docs/schema.prisma.txt || true

      - name: Build changelog
        run: |
          echo "=== Building Changelog ==="
          if [ -f "CHANGELOG.md" ]; then
            cp CHANGELOG.md docs/CHANGELOG.md
          fi

      - name: Generate scripts documentation
        run: |
          echo "=== Documenting Scripts ==="
          mkdir -p docs/scripts

          # Document all scripts
          echo "# Scripts Documentation" > docs/scripts/README.md
          echo "" >> docs/scripts/README.md
          echo "## Quality Scripts" >> docs/scripts/README.md
          find scripts/quality -name "*.sh" -o -name "*.ts" | while read script; do
            echo "### $(basename $script)" >> docs/scripts/README.md
            head -n 20 "$script" | grep -E "^#" | sed 's/^# //' >> docs/scripts/README.md
            echo "" >> docs/scripts/README.md
          done

          echo "## Utility Scripts" >> docs/scripts/README.md
          find scripts/utils -name "*.sh" -o -name "*.ts" | while read script; do
            echo "### $(basename $script)" >> docs/scripts/README.md
            head -n 20 "$script" | grep -E "^#" | sed 's/^# //' >> docs/scripts/README.md
            echo "" >> docs/scripts/README.md
          done

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/
          retention-days: 90

      - name: Deploy docs to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages

  # Job 5: Build Test
  build:
    name: Production Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: 'postgresql://dummy:dummy@localhost:5432/dummy'
          NEXTAUTH_SECRET: 'dummy-secret-for-ci-only-minimum-32-chars'
          NEXTAUTH_URL: 'http://localhost:3000'

      - name: Check build size
        run: |
          echo "=== Build Size Analysis ==="
          du -sh .next/ || true

          # Check if build is too large (>100MB warning)
          SIZE=$(du -sm .next/ | cut -f1)
          if [ "$SIZE" -gt 100 ]; then
            echo "âš ï¸  Warning: Build size is ${SIZE}MB (>100MB)"
          else
            echo "âœ… Build size: ${SIZE}MB"
          fi

      - name: Upload build artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: .next/
          retention-days: 7

  # Job 6: Notify on Success/Failure
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [quality, security, coverage, docs, build]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          echo "Quality: ${{ needs.quality.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Coverage: ${{ needs.coverage.result }}"
          echo "Docs: ${{ needs.docs.result }}"
          echo "Build: ${{ needs.build.result }}"

      - name: Set pipeline status
        id: status
        run: |
          if [ "${{ needs.quality.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Pipeline failed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… All checks passed" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "### ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
